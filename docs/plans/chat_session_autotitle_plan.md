# 会话自动命名方案

## 背景
聊天会话面板目前沿用后端默认生成的 `Session session_...` 标题，辨识度低，用户难以在列表中定位主题。目标是提供自动命名能力，为每个会话生成一句概括性标题，并支持随时重新生成。

## 目标
1. 新会话创建后，在几秒内生成可读标题。
2. 左侧会话列表呈现生成后的名称，旧记录可批量补全。
3. 用户可手动触发“重新生成标题”，便于更新主题。

## 方案概览

### 1. 后端 API 设计

| 方法 | 路径 | 功能 |
| ---- | ---- | ---- |
| `POST` | `/chat/sessions/{session_id}/autotitle` | 根据最近对话生成标题并持久化 |
| `POST` | `/chat/sessions/autotitle/bulk` | （可选）批量为未命名 session 生成标题 |

`autotitle` 请求体可选参数：
- `force`: `true` 时无论已有名称与否都重新生成；
- `strategy`: 预留字段（默认为 `llm` 或 `heuristic`），便于未来扩展。

响应体：
```jsonc
{
  "session_id": "session_xxx",
  "title": "超导噬菌体传播网络研究计划",
  "source": "heuristic" // or llm
}
```

### 2. 标题生成逻辑

封装成 `SessionTitleService`：

1. **上下文收集**  
   - 近 5~10 条对话，重点取 `user` 消息；  
   - 若绑定 plan，追加计划标题、当前任务名称；
   - 若最近 LLM 回复包含 `actions_summary`，提取其中的任务或操作。

2. **生成策略**（按优先级尝试）  
   - **计划优先**：若已绑定 plan，直接用 plan 标题；如存在当前任务，拼成“{计划标题} · {任务名}”。  
   - **启发式提取**：对用户消息做 TextRank/关键字抽取，过滤停用词后截取 10~16 字。例如“小样本噬菌体宿主预测策略”。  
   - **LLM 精炼**（可选）：调用轻量模型，提示语如“根据以下对话概括一个 12 字以内标题，避免标点”，生成失败时回退到启发式。

3. **落库**  
   - 更新 `chat_sessions` 表的 `name` 或 `title` 字段；
   - 保存生成来源（`heuristic` / `llm`），便于日志分析；
   - 若调用失败，返回错误并保持原标题。

### 3. 前端改动

1. **Store 同步**  
   - `useChatStore` 添加 `autotitleSession(sessionId, options)`，调用新接口并更新会话列表。
   - 新会话创建 (`startNewSession`) 后，在 `setTimeout` 或收到第一条 LLM 回复后触发自动命名。

2. **UI 交互**  
   - 会话列表项的快捷菜单增加“重新生成标题”，调用上述 store 方法；  
   - 当标题来源变化时，在列表或详情中显示提示（例如 Tooltip 显示“自动生成”）。

3. **批量补全**  
   - 可在设置页或 debug 面板加一个“修复旧标题”按钮，触发 `bulk` 接口。

### 4. 回滚与错误处理
| 场景 | 处理方式 |
| ---- | ---- |
| 会话历史不足 | 使用默认 `Session {timestamp}` 并标记 `source=default` |
| LLM 接口失败 | 记录错误（日志 + metrics），回退到启发式或默认标题 |
| 用户手动命名 | API 可提供 `PATCH /chat/sessions/{id}` 以手动覆盖，自动命名时检测 `is_user_named` 字段避免覆盖 |

### 5. 落实步骤
1. 新增 `SessionTitleService`（提取历史、生成标题、落库），并写单元测试。
2. 实现 `POST /chat/sessions/{id}/autotitle` 路由（调用 service，返回结果）。
3. 前端 `useChatStore` 接入新接口；会话列表 UI 加自动命名交互。
4. 构建 CLI/管理接口批量补全旧数据。
5. 回归测试：  
   - 新建会话 → 生成标题；  
   - 绑定计划 → 标题包含计划名；  
   - 触发“重新生成” → 标题更新且 UI 同步；  
   - LLM/启发式回退场景。

### 6. 未来扩展
- 接入更高质量摘要模型，并加缓存避免重复请求；
- 分析指标（成功率/耗时），逐渐实现多语言支持；
- 为特定计划或团队自定义命名风格。
